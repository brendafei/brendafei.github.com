---
title: SSH
categories: network
---

* toc
{:toc}


---

Secure Shell，安全外壳协议，是一种加密网络协议。用于在不受信任的网络环境中，提供安全登录、文件传输等功能。  
加密算法用于验证连接的两端，自动加密所有传输的数据，并保护数据的完整性。

## 历史

- 1995年，芬兰赫尔辛基工业大学的研究员 Tatu Ylönen 设计了第一个版本 SSH 1。[原始论文](https://www.usenix.org/legacy/publications/library/proceedings/sec96/full_papers/ylonen/index.html)
- 1995年12月，Tatu Ylönen 成立了公司 SCS，专门销售和开发 SSH。后续逐渐从免费软件变为商业软件。
- 1996年，SSH 2 协议提出，解决 SSH 1 协议的一些安全漏洞。与 SSH 1 版本不兼容。1998年推出软件实现，专有软件，不能免费使用。
- 1999年，OpenBSD 开发人员推出 SSH 2 协议的开源实现，即 OpenSSH 项目。该项目起初基于 SSH 1 的最后一个开源版本 1.2.12 实现，很快摆脱了原始代码。逐渐成为最流行的 SSH 实现。

以下内容为OpenSSH实现
{:.note}

## 架构

SSH 软件架构是 client-server 模式。OpenSSH 实现：client 为 ssh；server 为 sshd。

## 连接过程

1. ssh 连接远程服务器后，验证远程服务器是否为陌生地址
   1. 验证使用服务器指纹 fingerprint，服务器指纹为服务器公钥的散列值。每台 ssh 服务器都有唯一一对密钥，用于跟客户端通信，客户端通过这个指纹识别各个服务器
2. 如果为陌生地址，则提醒用户确认是否需要连接
3. 用户同意后，ssh 会将这个服务器的公钥指纹存储在本机的 `~/.ssh/known_hosts` 文件中

服务器指纹可以防止有人恶意冒充远程主机。如果服务器密钥发生变更，客户端再次连接时，就会发生公钥指纹不吻合的情况，客户端连接会发生中断并发出警告。
{:.note}

## 配置

### Client - ssh

**配置文件**

```shell
man ssh_config  # 可以通过该命令查看客户端配置手册
```

- 客户端全局配置文件： `/etc/ssh/ssh_config`  
- 用户个人配置文件： `~/.ssh/config` 优先级高于全局配置文件

**配置内容**

- `Host`：主机配置。可以配置各个服务器的连接参数，而不必每次都重复输入
  - 如下配置后，直接通过 `ssh remoteserver` 就可以连接该服务器
```shell
    Host remoteserver               # 这边如果填 * ，表示对所有服务器生效，* 可以被单独配置覆盖
      HostName remote.example.com
      User username
      Port 1234
```

- `ServerAliveInterval`：client 端的空闲等待间隔，单位：秒。即 client 没收到 server 返回，等多久向 server 发送 keepalive 消息，以保持连接处于活跃状态。填 0 则表示不发送
- `ServerAliveCountMax`：client 向 server 发送 keepalive 消息的最大次数
- `Compression`：是否压缩传输信号，默认 no
- ...

### Server - sshd

**配置文件**

```shell
man sshd_config  # 可以通过该命令查看服务器配置手册
```

- 配置文件位置： `/etc/ssh/sshd_config`

修改配置文件后，可以使用 `sshd -t` 命令验证配置文件是否有语法错误  
使新配置生效，需要重启 sshd ： `sudo systemctl restart sshd`
{:.note}


## 服务器登录方式

SSH 支持密码登录、密钥登录、证书登录。默认密码登录。

### 密码登录

需要输入服务器密码，不方便 & 不安全，可能被暴力破解

### 密钥登录

- SSH 密钥登录采用非对称加密，非对称加密需要两个密钥成对使用，私钥和公钥一一对应
- 需要服务器保存用户公钥，用户需要保存服务器公钥指纹。对于多用户、多服务器场景，使用不方便，不再使用的公钥需要从服务器维护删除

**密钥登录过程**

1. 客户端 通过 `ssh-keygen` 生成自己的公钥和私钥
2. 将公钥放入远程服务器指定位置（可使用 `ssh-copy-id` 命令）
3. 客户端发起ssh登录请求
4. 服务器收到登录请求，发送一些随机数给用户，要求用户证明身份
5. 客户端收到服务器发来的数据，使用**私钥对数据进行签名**，发送给服务器
6. 服务器使用公钥解密，跟原始数据比较，一致则验证通过

### 证书登录

- 引入一个证书颁发机构，certificate authority, CA。对信任的服务器颁发服务器证书、对信任的用户颁发用户证书
- 登录时，用户和服务器不需要提前知道彼此的公钥，只需要交换各自的证书，验证是否可信
- 证书优点：无需

## 协议详细执行流程

![Full-width image](/assets/images/ssh-connection-steps.jpeg){:.lead width="600" loading="lazy"}


## 其他
- Port forwarding / ssh tunnel
  - 可以利用 ssh 的端口转发功能实现简单的 VPN 功能。此时，ssh 充当两台服务器之间的通信加密跳板
    - `-L` 为本地转发，其他的还有 `-D` 动态转发， `-R` 远程转发
```shell
ssh -L 2080:corp-server:80 tunnel-host -N
# 通过 ssh 跳板机 tunnel-host 将本机 2080 端口绑定到 corp-server 80 端口
# 从而可以通过 http://localhost:2080 访问 corp-server 80 端口
# -N 表示只使用转发功能，不能执行命令
```
- 查看服务器 sshd 日志： `journalctl -u sshd -f`


## 参考资料
- [SSH - Secure Login Connections over the Internet](https://www.usenix.org/legacy/publications/library/proceedings/sec96/full_papers/ylonen/index.html)
- [SSH教程](https://www.cainiaojc.com/ssh/ssh-index.html)
- [SSH Protocol](https://www.ssh.com/academy/ssh/protocol)